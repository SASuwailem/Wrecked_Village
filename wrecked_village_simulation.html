<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üèòÔ∏è Wrecked Village Debt Simulation</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {font-family: sans-serif; max-width:800px; margin:auto; padding:20px; background:#f7f7f7;}
    input,button {padding:8px; width:100%; margin:6px 0; box-sizing:border-box;}
    button {background-color:#007BFF; color:white; border:none; cursor:pointer;}
    button:hover {background-color:#0056b3;}
    .chart-container {margin-top:30px; height:350px;}
    pre {background:#efefef; padding:10px; white-space:pre-wrap; border-radius:4px;}
  </style>
</head>
<body>

<h2>üèòÔ∏è Wrecked Village Debt Simulation</h2>

<label>Number of Villagers: <input id="villagers" type="number" value="5"></label>
<label>Loan per Villager (dinars): <input id="loan" type="number" value="100"></label>
<label>Interest Rate (% per year): <input id="interest" type="number" value="4"></label>
<label>Number of Years: <input id="years" type="number" value="15"></label>

<button onclick="runSimulation()">Run Simulation</button>

<div class="chart-container"><canvas id="debtChart"></canvas></div>
<div class="chart-container"><canvas id="percentChart"></canvas></div>
<div class="chart-container"><canvas id="winnerChart"></canvas></div>

<pre id="summary"></pre>

<script>
let charts = {};

function runSimulation(){
  const villagers = +document.getElementById('villagers').value;
  const loan = +document.getElementById('loan').value;
  const interest = (+document.getElementById('interest').value)/100;
  const years = +document.getElementById('years').value;

  const totalMoney = villagers * loan;
  let debts = Array(villagers).fill(loan);
  let summary = [];

  for(let year=1; year<=years; year++){
    // Step 1: Add interest to previous debts
    debts = debts.map(d => d*(1+interest));

    const totalDebtBeforeRepayment = debts.reduce((a,b)=>a+b,0);

    // Step 2: Randomize repayment order
    debts.sort(()=>Math.random()-0.5);

    // Step 3: Repayment
    let availableMoney = totalMoney;
    let winners=0;
    debts = debts.map(d=>{
      if(availableMoney>=d){availableMoney-=d; winners++; return 0;}
      let remainingDebt = d-availableMoney;
      availableMoney=0; return remainingDebt;
    });
    let unpaidDebt = debts.reduce((a,b)=>a+b,0);
    let losers = villagers - winners;

    summary.push({year,totalDebtBeforeRepayment,unpaidDebt,winners,losers});

    // Step 4: Borrow again next year (no immediate interest)
    debts = debts.map(d=>d+loan);
  }

  // Display summary
  const lastYear=summary[summary.length-1];
  document.getElementById('summary').innerText=
`--- Simulation Summary ---
Number of villagers: ${villagers}
Loan per villager: ${loan} dinars
Total initial principal: ${totalMoney} dinars
Last year's total debt before repayment: ${lastYear.totalDebtBeforeRepayment.toFixed(2)} dinars
Last year's winners: ${lastYear.winners}
Last year's losers: ${lastYear.losers}`;

  plotAllCharts(summary,totalMoney);
}

function plotAllCharts(summary,totalPrincipal){
  const labels = summary.map(s=>`Year ${s.year}`);

  // Total Debt Chart
  plotChart("debtChart", labels, [
    {label:"Total Debt Before Repayment",data:summary.map(s=>s.totalDebtBeforeRepayment),borderColor:"red"},
    {label:"Unpaid Debt Carried Over",data:summary.map(s=>s.unpaidDebt),borderColor:"blue"}
  ],"Debt Accumulation","Debt (dinars)");

  // Percentage Unpaid Debt Chart
  plotChart("percentChart", labels, [
    {label:"% Unpaid Debt to Principal",
     data:summary.map(s=>(s.unpaidDebt/totalPrincipal)*100),
     borderColor:"purple"}
  ],"Percentage of Unpaid Debt to Principal","Percentage (%)");

  // Winners vs Losers Chart
  plotChart("winnerChart", labels, [
    {label:"Winners",data:summary.map(s=>s.winners),borderColor:"green"},
    {label:"Losers",data:summary.map(s=>s.losers),borderColor:"orange"}
  ],"Winners vs Losers","Number of Villagers");
}

function plotChart(canvasId,labels,datasets,title,ylabel){
  if(charts[canvasId]) charts[canvasId].destroy();
  charts[canvasId]=new Chart(document.getElementById(canvasId),{
    type:"line",
    data:{labels,datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{title:{display:true,text:title}},
      scales:{y:{title:{display:true,text:ylabel}}}
    }
  });
}

// Run simulation automatically on page load
window.onload=runSimulation;
</script>

</body>
</html>
